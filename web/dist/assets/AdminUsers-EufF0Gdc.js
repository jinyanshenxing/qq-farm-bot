import{m as T,o as i,c as _,a as b,b as a,w as s,I as F,s as V,r as n,J as O,e as u,f as j,A as G,i as m,t as x,F as L,y as H,p as K,G as P,E as p}from"./index-Dyl5uCa_.js";import{_ as R,m as W,g as X,n as Y,o as Z,p as ee}from"./_plugin-vue_export-helper-fxonzzrb.js";const le={class:"admin-users-view"},ae={class:"section-card"},te={class:"section-header"},se={key:0,class:"hint-text"},oe={key:1},ne={key:2,class:"hint-text"},de={__name:"AdminUsers",setup(re){const h=u([]),g=u(!1),c=u(!1),d=u(!1),y=u(!1),C=u([]),t=u({id:null,username:"",password:"",role:"user",allowedUins:[]});async function U(){g.value=!0;try{const o=await W();h.value=(o.data||[]).map(e=>({...e,allowedUins:e.allowed_uins?JSON.parse(e.allowed_uins):[]}))}catch{}finally{g.value=!1}}async function E(){try{const o=await X();C.value=(o.data||[]).map(e=>String(e.uin))}catch{}}function N(){d.value=!1,t.value={id:null,username:"",password:"",role:"user",allowedUins:[]},c.value=!0}function Q(o){d.value=!0,t.value={id:o.id,username:o.username,password:"",role:o.role,allowedUins:[...o.allowedUins||[]]},c.value=!0}async function D(){var o,e;if(!t.value.username){p.warning("请输入用户名");return}if(!d.value&&!t.value.password){p.warning("请输入密码");return}y.value=!0;try{const r={username:t.value.username,role:t.value.role,allowed_uins:JSON.stringify(t.value.role==="admin"?[]:t.value.allowedUins)};t.value.password&&(r.password=t.value.password),d.value?(await Z(t.value.id,r),p.success("用户已更新")):(r.password=t.value.password,await ee(r),p.success("用户已创建")),c.value=!1,U()}catch(r){p.error(((e=(o=r.response)==null?void 0:o.data)==null?void 0:e.error)||r.message)}finally{y.value=!1}}async function S(o){try{await P.confirm(`确定要删除用户 "${o.username}" 吗?`,"警告",{type:"warning",confirmButtonText:"删除",cancelButtonText:"取消"}),await Y(o.id),p.success("已删除"),U()}catch{}}return T(()=>{U(),E()}),(o,e)=>{const r=n("el-icon"),v=n("el-button"),f=n("el-table-column"),z=n("el-tag"),$=n("el-table"),A=n("el-input"),w=n("el-form-item"),k=n("el-option"),B=n("el-select"),q=n("el-form"),I=n("el-dialog"),J=O("loading");return i(),_("div",le,[b("div",ae,[b("div",te,[e[7]||(e[7]=b("h3",{class:"section-title"},"用户管理",-1)),a(v,{type:"primary",size:"small",onClick:N},{default:s(()=>[a(r,{style:{"margin-right":"4px"}},{default:s(()=>[a(j(G))]),_:1}),e[6]||(e[6]=m(" 添加用户 ",-1))]),_:1})]),F((i(),V($,{data:h.value,stripe:"",style:{width:"100%"},"header-cell-style":{background:"var(--bg-base)",color:"var(--text-muted)",borderColor:"var(--border)"},"cell-style":{background:"var(--bg-surface)",color:"var(--text-secondary)",borderColor:"var(--border)"}},{default:s(()=>[a(f,{label:"ID",prop:"id",width:"60",align:"center"}),a(f,{label:"用户名",prop:"username",width:"150"}),a(f,{label:"角色",width:"100",align:"center"},{default:s(({row:l})=>[a(z,{type:l.role==="admin"?"danger":"info",size:"small",effect:"dark"},{default:s(()=>[m(x(l.role==="admin"?"管理员":"普通用户"),1)]),_:2},1032,["type"])]),_:1}),a(f,{label:"可访问QQ","min-width":"200"},{default:s(({row:l})=>[l.role==="admin"?(i(),_("span",se,"全部")):l.allowedUins&&l.allowedUins.length?(i(),_("span",oe,x(l.allowedUins.join(", ")),1)):(i(),_("span",ne,"未分配"))]),_:1}),a(f,{label:"操作",width:"160",align:"center"},{default:s(({row:l})=>[a(v,{text:"",type:"primary",size:"small",onClick:M=>Q(l)},{default:s(()=>[...e[8]||(e[8]=[m("编辑",-1)])]),_:1},8,["onClick"]),a(v,{text:"",type:"danger",size:"small",onClick:M=>S(l),disabled:l.id===1},{default:s(()=>[...e[9]||(e[9]=[m(" 删除 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[J,g.value]])]),a(I,{modelValue:c.value,"onUpdate:modelValue":e[5]||(e[5]=l=>c.value=l),title:d.value?"编辑用户":"添加用户",width:"420px","close-on-click-modal":!1,class:"dark-dialog"},{footer:s(()=>[a(v,{onClick:e[4]||(e[4]=l=>c.value=!1)},{default:s(()=>[...e[11]||(e[11]=[m("取消",-1)])]),_:1}),a(v,{type:"primary",onClick:D,loading:y.value},{default:s(()=>[m(x(d.value?"保存":"创建"),1)]),_:1},8,["loading"])]),default:s(()=>[a(q,{model:t.value,"label-width":"90px"},{default:s(()=>[a(w,{label:"用户名",required:""},{default:s(()=>[a(A,{modelValue:t.value.username,"onUpdate:modelValue":e[0]||(e[0]=l=>t.value.username=l),disabled:d.value,placeholder:"输入用户名"},null,8,["modelValue","disabled"])]),_:1}),a(w,{label:d.value?"新密码":"密码",required:!d.value},{default:s(()=>[a(A,{modelValue:t.value.password,"onUpdate:modelValue":e[1]||(e[1]=l=>t.value.password=l),type:"password","show-password":"",placeholder:d.value?"留空则不修改":"输入密码"},null,8,["modelValue","placeholder"])]),_:1},8,["label","required"]),a(w,{label:"角色"},{default:s(()=>[a(B,{modelValue:t.value.role,"onUpdate:modelValue":e[2]||(e[2]=l=>t.value.role=l),style:{width:"100%"}},{default:s(()=>[a(k,{label:"管理员",value:"admin"}),a(k,{label:"普通用户",value:"user"})]),_:1},8,["modelValue"])]),_:1}),t.value.role==="user"?(i(),V(w,{key:0,label:"可访问QQ"},{default:s(()=>[a(B,{modelValue:t.value.allowedUins,"onUpdate:modelValue":e[3]||(e[3]=l=>t.value.allowedUins=l),multiple:"",filterable:"","allow-create":"",placeholder:"输入或选择QQ号",style:{width:"100%"}},{default:s(()=>[(i(!0),_(L,null,H(C.value,l=>(i(),V(k,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[10]||(e[10]=b("div",{class:"field-hint"},"管理员可访问所有账号，普通用户仅限已分配的",-1))]),_:1})):K("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},ce=R(de,[["__scopeId","data-v-4a220eae"]]);export{ce as default};
